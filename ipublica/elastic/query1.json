{
  "aggs": {
    "users": {
      "terms": {
        "field": "Comprador.RutUsuario.keyword",
        "size": 30
      },
      "aggs": {
        "items": {
          "nested": {
            "path": "Items.Listado"
          },
          "aggs": {
            "providers": {
              "terms": {
                "field": "Items.Listado.Adjudicacion.RutProveedor.keyword",
                "size": 1
              },
              "aggs": {
                "avg_ammount_provider": {
                  "avg": {
                    "field": "Items.Listado.Adjudicacion.MontoUnitario"
                  }
                },
                "sum_ammount_provider": {
                  "sum": {
                    "field": "Items.Listado.Adjudicacion.MontoUnitario"
                  }
                }
              }
            },
            "max_count_provider": {
              "max_bucket": {
                "buckets_path": "providers>_count"
              }
            }
          }
        },
        "order_a": {
          "bucket_sort": {
            "sort": [
              {
                "items>max_count_provider": "desc"
              }
            ]
          }
        }
      }
    }
  }
}
